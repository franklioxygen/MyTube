name: Build and Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
    
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install Dependencies
      run: npm run install:all
      
    - name: Lint Frontend
      run: |
        cd frontend
        npm run lint

    - name: Check New Complexity Issues
      run: npm run complexity:check-new
        
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
        
    - name: Build Backend
      run: |
        cd backend
        npm run build
        
    - name: Test Backend
      run: |
        cd backend
        npm run test -- run

    - name: Generate Coverage Reports
      if: ${{ env.CODACY_PROJECT_TOKEN != '' }}
      run: |
        cd backend
        npm run test:coverage -- --coverage.reporter=lcov

        cd ../frontend
        npm run test:coverage -- --coverage.reporter=lcov

    - name: Upload Coverage Reports to Codacy
      if: ${{ env.CODACY_PROJECT_TOKEN != '' }}
      run: |
        bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
          --partial \
          --force-coverage-parser lcov \
          --prefix backend/ \
          -r backend/coverage/lcov.info

        bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
          --partial \
          --force-coverage-parser lcov \
          --prefix frontend/ \
          -r frontend/coverage/lcov.info

        bash <(curl -Ls https://coverage.codacy.com/get.sh) final
